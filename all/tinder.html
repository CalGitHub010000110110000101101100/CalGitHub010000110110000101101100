<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Sitemap Tinder</title>
    <meta
      name="description"
      content="Quickly preview and reject the many web pages on this website."
    />

    <link rel="stylesheet" type="text/css" href="/sheep3.css" />
    <script src="/sheep3.js" charset="utf-8"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Design based on https://dribbble.com/shots/15212873/attachments/6958010?mode=media */

      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, 'Helvetica Neue', Helvetica, Arial, 'PingFang TC',
          'Source Han Sans TC', 'Source Han Sans TW', 'Noto Sans CJK TC',
          'Microsoft Jhenghei', MOESongUN, PMingLiU, PMingLiU-ExtB, MingLiU,
          MingLiU-ExtB, Ming, 'Heiti TC', HanaMinA, HanaMinB, sans-serif,
          'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
        font-size: 14px;
        display: flex;
      }
      button,
      input,
      select,
      textarea {
        -webkit-appearance: none;
        border: none;
        background: none;
        color: inherit;
        font: inherit;
      }
      button:not(:disabled) {
        cursor: pointer;
      }
      .cards {
        flex: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }
      .card {
        display: flex;
        flex-direction: column;
        height: 36em;
        width: 20em;
        margin: -18em -10em;
        border-radius: 2em;
        overflow: hidden;
        box-shadow: 0 0.36em 2em rgba(52, 67, 77, 0.2);
        background-color: white;
        position: relative;
        /* Scale card down to zoom out iframe */
        font-size: 2em;
        transform: scale(0.5);
      }
      .back {
        background-image: url('./assets/card-back.svg'),
          linear-gradient(-15deg, #bec4ce, #e3eaef);
        background-size: 8em, auto;
        background-position: center;
        background-repeat: no-repeat;
      }
      .rejected {
        animation: rejected 0.8s cubic-bezier(1, 0, 1, 1) forwards;
      }
      @keyframes rejected {
        from {
          transform: scale(0.5);
        }
        to {
          transform: translate(-18em, 50vh) translateY(100%) scale(0.5)
            rotate(-60deg);
        }
      }
      .accepted {
        animation: accepted 0.8s cubic-bezier(1, 0, 1, 1) forwards;
      }
      @keyframes accepted {
        from {
          transform: scale(0.5);
        }
        to {
          transform: translateX(50vw) translateX(100%) scale(0.8) rotate(15deg);
        }
      }
      .unselected {
        transform: scale(0.45);
      }
      .ascend {
        animation: ascend 0.8s cubic-bezier(0.7, 0, 0.3, 1) 0.2s backwards;
      }
      @keyframes ascend {
        from {
          transform: scale(0.45);
        }
        to {
          transform: scale(0.5);
        }
      }
      .flip-out {
        animation: flip-out 0.5s cubic-bezier(0.4, 0, 1, 0.6) forwards;
      }
      @keyframes flip-out {
        from {
          transform: scale(0.5) perspective(1000px);
        }
        to {
          transform: scale(0.5) perspective(1000px) rotateY(90deg);
        }
      }
      .flip-in {
        animation: flip-in 0.5s cubic-bezier(0, 0.4, 0.6, 1) 0.5s backwards;
      }
      @keyframes flip-in {
        from {
          transform: scale(0.5) perspective(1000px) rotateY(-90deg);
        }
        to {
          transform: scale(0.5) perspective(1000px);
        }
      }
      .come-in {
        animation: come-in 0.5s 0.3s both;
      }
      @keyframes come-in {
        from {
          transform: scale(0.3);
        }
        to {
          transform: scale(0.45);
        }
      }
      .preview {
        flex: auto;
      }
      .iframe {
        height: 100%;
        width: 100%;
        border: none;
        pointer-events: none;
      }
      .buttons {
        display: flex;
        justify-content: center;
        padding: 10px;
      }
      .card-btn {
        width: 3.5em;
        height: 3.5em;
        box-shadow: 0 0.2em 1em rgba(146, 43, 113, 0.3);
        border-radius: 50%;
        background-size: 1.75em;
        background-position: center;
        background-repeat: no-repeat;
        margin: 0.7em;
        transition: box-shadow 0.2s;
      }
      .card-btn:hover {
        box-shadow: 0 0.5em 1.5em rgba(146, 43, 113, 0.3);
      }
      .card-btn:active {
        box-shadow: 0 0.1em 0.2em rgba(146, 43, 113, 0.3);
      }
      .reject-btn {
        background-image: url('./assets/material-close.svg');
      }
      .accept-btn {
        background-image: url('./assets/material-favourite.svg'),
          linear-gradient(-60deg, #ff0063, #e34dff);
        background-size: 1.75em, auto;
      }
      .meta {
        padding: 1.5em;
        padding-bottom: 0;
      }
      .title {
        font-weight: 800;
        margin: 0;
        font-size: 2em;
        line-height: 1;
      }
      .description {
        margin: 0;
        margin-top: 0.5em;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <section class="cards" id="cards">
      <article class="card back hidden" id="deck"></article>
      <article class="card back" id="next"></article>
    </section>
    <section class="likes"></section>
    <script src="../javascripts/_dom2.js"></script>
    <script>
      let paths
      fetch('./sitemap.txt')
        .then(r => r.text())
        .then(sitemap => {
          paths = sitemap
            .trim()
            // TEMP
            .replaceAll('https://sheeptester.github.io', '')
            .split(/\r?\n/)
            .reverse()
          showCardForPath(paths.pop())
        })

      function createCard (path, title, description) {
        const iframe = Elem('iframe', {
          className: 'iframe',
          src: path,
          tabIndex: -1,
          sandbox: 'allow-same-origin'
        })
        iframe.addEventListener('load', () => {
          iframe.contentDocument.body.style.overflow = 'hidden'
        })
        const rejectBtn = Elem('button', {
          className: 'card-btn reject-btn',
          title: 'This does not please me.',
          ariaLabel: 'This does not please me.'
        })
        rejectBtn.addEventListener('click', async () => {
          if (animationEnd) await animationEnd
          next.classList.replace('unselected', 'ascend')
          card.classList.add('rejected')
        })
        const acceptBtn = Elem('button', {
          className: 'card-btn accept-btn',
          title: 'This sparks joy.',
          ariaLabel: 'This sparks joy.'
        })
        acceptBtn.addEventListener('click', async () => {
          if (animationEnd) await animationEnd
          next.classList.replace('unselected', 'ascend')
          card.classList.add('accepted')
        })
        const card = Elem('article', { className: 'card' }, [
          Elem('div', { className: 'preview' }, [iframe]),
          Elem('div', { className: 'meta' }, [
            Elem('h2', { className: 'title' }, [title]),
            description &&
              Elem('p', { className: 'description' }, [description])
          ]),
          Elem('buttons', { className: 'buttons' }, [rejectBtn, acceptBtn])
        ])
        return card
      }

      const cards = document.getElementById('cards')
      const deck = document.getElementById('deck')
      const next = document.getElementById('next')
      const parser = new DOMParser()
      let animationEnd
      async function showCardForPath (path) {
        // Assumes that the `next` card is ready to be flipped. This is already
        // the case after accepting/rejecting.
        const doc = await fetch(path)
          .then(r => r.text())
          .then(html => parser.parseFromString(html, 'text/html'))
        const card = createCard(
          path,
          doc.querySelector('title')?.textContent ?? path,
          doc
            .querySelector('meta[name="description"][content]')
            ?.getAttribute('content')
        )
        cards.append(card)
        deck.classList.replace('hidden', 'come-in')
        next.classList.remove('ascend')
        next.classList.add('flip-out')
        card.classList.add('flip-in')
        animationEnd = new Promise(resolve => {
          card.addEventListener(
            'animationend',
            () => {
              // Animation of card flip is done.
              deck.classList.replace('come-in', 'hidden')
              next.classList.replace('flip-out', 'unselected')
              card.classList.remove('flip-in')
              resolve()
              card.addEventListener('animationend', () => {
                // Animation of card toss is done.
                card.remove()
                showCardForPath(paths.pop())
              })
            },
            { once: true }
          )
        })
      }
    </script>
  </body>
</html>
