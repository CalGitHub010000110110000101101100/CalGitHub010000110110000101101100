<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tinder but for web pages</title>
    <meta
      name="description"
      content="Quickly preview and reject the many web pages on this website."
    />

    <link rel="stylesheet" type="text/css" href="/sheep3.css" />
    <script src="/sheep3.js" charset="utf-8"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Design based on https://dribbble.com/shots/15212873/attachments/6958010?mode=media */

      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        /*
          Includes fonts (from Wiktionary) for Traditional Chinese and Hangul
          because of /vertical/.
          Latin font stack is from paly.win + GitHub.
          Admittedly, just `'Monsterrat', sans-serif` would probably suffice.
        */
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, 'Helvetica Neue', Helvetica, Arial, 'PingFang TC',
          'Source Han Sans TC', 'Source Han Sans TW', 'Noto Sans CJK TC',
          'Microsoft Jhenghei', MOESongUN, PMingLiU, PMingLiU-ExtB, MingLiU,
          MingLiU-ExtB, Ming, 'Heiti TC', HanaMinA, HanaMinB,
          'Apple SD Gothic Neo', 'Malgun Gothic', Dotum, Gulim,
          'NanumBarunGothic YetHangul', NanumBarunGothic, UnDotum,
          'Source Han Sans K', 'Source Han Sans KR', 'Noto Sans CJK KR',
          NanumGothic, 'NanumMyeongjo YetHangul', NanumMyeongjo, Batang,
          UnBatang, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
          'Segoe UI Symbol';
        font-size: 14px;
        display: flex;
        overflow-x: hidden;
      }
      button,
      input,
      select,
      textarea {
        -webkit-appearance: none;
        border: none;
        background: none;
        color: inherit;
        font: inherit;
      }
      button:not(:disabled) {
        cursor: pointer;
      }
      .cards {
        flex: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }
      .card {
        display: flex;
        flex-direction: column;
        height: 36em;
        width: 20em;
        margin: -18em -10em;
        border-radius: 2em;
        box-shadow: 0 0.36em 2em rgba(52, 67, 77, 0.2);
        background-color: white;
        position: relative;
        /* Scale card down to zoom out iframe */
        font-size: 2em;
        transform: scale(0.5);
      }
      .back {
        background-image: url('./assets/card-back.svg'),
          linear-gradient(-15deg, #bec4ce, #e3eaef);
        background-size: 8em, auto;
        background-position: center;
        background-repeat: no-repeat;
      }
      .rejected,
      .accepted {
        z-index: 100;
      }
      .rejected {
        animation: rejected 0.8s cubic-bezier(1, 0, 1, 1) forwards;
      }
      @keyframes rejected {
        from {
          transform: scale(0.5);
        }
        to {
          transform: translate(-18em, 50vh) translateY(100%) scale(0.5)
            rotate(-60deg);
        }
      }
      .accepted {
        animation: accepted 0.8s cubic-bezier(1, 0, 1, 1) forwards;
      }
      @keyframes accepted {
        from {
          transform: scale(0.5);
        }
        to {
          transform: translateX(50vw) translateX(100%) scale(0.8) rotate(15deg);
        }
      }
      .unselected {
        transform: scale(0.45);
      }
      .flip-out {
        animation: flip-out 0.5s cubic-bezier(0.4, 0, 1, 0.6) forwards;
      }
      @keyframes flip-out {
        from {
          transform: scale(0.45) perspective(70em);
        }
        to {
          transform: scale(0.5) perspective(70em) rotateY(90deg);
        }
      }
      .flip-in {
        animation: flip-in 0.5s cubic-bezier(0, 0.4, 0.6, 1) 0.5s backwards;
      }
      @keyframes flip-in {
        from {
          transform: scale(0.5) perspective(70em) rotateY(-90deg);
        }
        to {
          transform: scale(0.5) perspective(70em);
        }
      }
      .come-in {
        animation: come-in 0.5s 0.3s both;
      }
      @keyframes come-in {
        from {
          transform: scale(0.3);
        }
        to {
          transform: scale(0.45);
        }
      }
      .preview {
        flex: auto;
        position: relative;
      }
      .iframe {
        height: 100%;
        width: 100%;
        border: none;
        pointer-events: none;
        border-top-left-radius: 2em;
        border-top-right-radius: 2em;
      }
      .buttons {
        display: flex;
        justify-content: center;
        padding: 1em;
      }
      .card-btn {
        width: 3.5em;
        height: 3.5em;
        box-shadow: 0 0.2em 1em rgba(146, 43, 113, 0.3);
        border-radius: 50%;
        background-size: 1.75em;
        background-position: center;
        background-repeat: no-repeat;
        margin: 0.7em;
        transition: box-shadow 0.2s;
      }
      .card-btn:hover {
        box-shadow: 0 0.5em 1.5em rgba(146, 43, 113, 0.3);
      }
      .card-btn:active {
        box-shadow: 0 0.1em 0.2em rgba(146, 43, 113, 0.3);
      }
      .reject-btn {
        background-image: url('./assets/material-close.svg');
      }
      .accept-btn {
        background-image: url('./assets/material-favourite.svg'),
          linear-gradient(-60deg, #ff0063, #e34dff);
        background-size: 1.75em, auto;
      }
      .open-btn {
        display: inline-block;
        position: absolute;
        bottom: 0;
        right: 0;
        background-image: url('./assets/material-launch.svg');
        background-color: rgba(232, 13, 88, 0.5);
        -webkit-backdrop-filter: blur(0.5em);
        backdrop-filter: blur(0.5em);
      }
      .meta {
        padding: 1.5em;
        padding-bottom: 0;
        word-break: break-word;
        white-space: pre-wrap;
      }
      .title {
        font-weight: 800;
        margin: 0;
        font-size: 2em;
        line-height: 1;
      }
      .description {
        margin: 0;
        margin-top: 0.5em;
      }
      .hidden {
        display: none;
      }
      .badges {
        margin-top: 0.5em;
        margin-right: -1.5em;
      }
      .badge {
        display: inline-block;
        padding: 0.4em 1em;
        border-radius: 2em;
        margin-right: 0.5em;
        text-transform: uppercase;
      }
      .js-badge {
        background-color: #f0db4f;
        color: #323330;
      }
      .visited-badge {
        pointer-events: none;
        color: white;
        background-color: white;
        text-decoration: none;
        user-select: none;
      }
      .visited-badge:visited {
        background-color: #b527e0;
      }
      .era-badge {
        color: white;
      }
      .era-1-badge {
        background-image: linear-gradient(120deg, #92c1bc, #6391a0);
      }
      .era-2-badge {
        background-image: linear-gradient(120deg, #ff8025, #e828ad);
      }
      .era-3-badge {
        background-image: linear-gradient(120deg, #20de88, #28bbe8);
      }

      .likes {
        display: flex;
        flex-direction: column;
        width: 250px;
        box-shadow: 0 0 15px rgba(52, 67, 77, 0.2);
        transition: margin-left 0.5s, transform 0.5s, box-shadow 0.5s;
      }
      .hide-likes {
        margin-left: -250px;
        transform: translateX(250px);
        box-shadow: none;
      }
      .likes-heading {
        font-size: 24px;
        margin: 0;
        padding: 20px;
        font-weight: 800;
      }
      .list {
        flex: auto;
        overflow: auto;
        padding-bottom: 70px;
      }
      .liked {
        display: flex;
        flex-direction: column;
        height: 60px;
        box-sizing: border-box;
        text-decoration: none;
        padding: 10px 20px;
        color: inherit;
        justify-content: space-between;
      }
      .liked:hover {
        background-color: rgba(0, 0, 0, 0.05);
      }
      .liked:visited {
        color: #a3a3a3;
      }
      .like-title,
      .like-description {
        white-space: pre;
        text-overflow: ellipsis;
        overflow: hidden;
        margin: 0;
      }
      .like-title {
        font-weight: 800;
      }
      .spacer {
        display: block;
      }
      .slide-in {
        animation: slide-in 0.5s;
      }
      @keyframes slide-in {
        from {
          margin-top: -60px;
        }
        to {
          margin-top: 0;
        }
      }
    </style>
  </head>
  <body>
    <section class="cards" id="cards">
      <article class="card back hidden" id="deck"></article>
      <article class="card back unselected" id="next"></article>
    </section>
    <section class="likes hide-likes" id="likes">
      <h2 class="likes-heading">Inspection list</h2>
      <div class="list" id="list">
        <span class="spacer" id="spacer"></span>
      </div>
    </section>
    <script src="../javascripts/_dom2.js"></script>
    <script>
      const params = new URL(window.location).searchParams

      const LS_ID = '[all] tinder.likes'
      let results
      try {
        results = JSON.parse(localStorage.getItem(LS_ID))
        if (!Array.isArray(results.likes) || !Array.isArray(results.dislikes)) {
          throw new TypeError('Weird structure.')
        }
      } catch {
        results = { likes: [], dislikes: [] }
      }

      let paths
      fetch('./sitemap.txt')
        .then(r => r.text())
        .then(sitemap => {
          paths = sitemap.trim().split(/\r?\n/)
          if (params.get('shuffle') === 'false') {
            paths.reverse()
          } else {
            // Shuffle
            for (let i = paths.length; i--; ) {
              const index = Math.floor(Math.random() * (i + 1))
              if (i !== index) {
                ;[paths[i], paths[index]] = [paths[index], paths[i]]
              }
            }
          }
          const alreadySeen = [
            ...results.dislikes,
            ...results.likes.map(({ path }) => path)
          ]
          paths = paths.filter(path => !alreadySeen.includes(path)).slice(0, 1)
          showCardForPath(paths.pop())
        })

      const likesContainer = document.getElementById('likes')
      const likesList = document.getElementById('list')
      const spacer = document.getElementById('spacer')
      spacer.addEventListener('animationend', () => {
        spacer.classList.remove('slide-in')
      })
      function createCard (path, title, description, era, requiresJs) {
        const iframe = Elem('iframe', {
          className: 'iframe',
          src: path,
          tabIndex: -1,
          sandbox: 'allow-same-origin'
        })
        iframe.addEventListener('load', () => {
          if (iframe.contentDocument) {
            iframe.contentDocument.body.style.overflow = 'hidden'
          }
        })
        let decided = false
        const handleDecision = async decision => {
          if (decided) return
          const accept = decision === 'accepted'
          if (accept) {
            results.likes.push({ path, title, description })
          } else {
            results.dislikes.push(path)
          }
          localStorage.setItem(LS_ID, JSON.stringify(results))
          if (animationEnd) await animationEnd
          card.classList.add(decision)
          if (accept) likesContainer.classList.remove('hide-likes')
          card.addEventListener(
            'animationend',
            () => {
              // Animation of card toss is done.
              card.remove()
              if (accept) {
                spacer.classList.add('slide-in')
                spacer.after(createLiked(path, title, description))
              }
            },
            { once: true }
          )
          showCardForPath(paths.pop())
        }
        const rejectBtn = Elem('button', {
          className: 'card-btn reject-btn',
          title: 'This does not please me.',
          ariaLabel: 'This does not please me.'
        })
        rejectBtn.addEventListener('click', () => handleDecision('rejected'))
        const acceptBtn = Elem('button', {
          className: 'card-btn accept-btn',
          title: 'This sparks joy.',
          ariaLabel: 'This sparks joy.'
        })
        acceptBtn.addEventListener('click', () => handleDecision('accepted'))
        const card = Elem('article', { className: 'card' }, [
          Elem('div', { className: 'preview' }, [
            iframe,
            Elem('a', {
              className: 'card-btn open-btn',
              href: path,
              target: '_blank',
              title: 'Open site in new tab',
              ariaLabel: 'Open site in new tab'
            })
          ]),
          Elem('div', { className: 'meta' }, [
            Elem('h2', { className: 'title' }, [title]),
            description &&
              Elem('p', { className: 'description' }, [description]),
            Elem('div', { className: 'badges' }, [
              era &&
                Elem(
                  'span',
                  {
                    className: `badge era-badge era-${era}-badge`,
                    title:
                      era === 3
                        ? 'Made between 2018-12-15 and today.'
                        : era === 2
                        ? 'Made between 2017-11-30 and 2018-12-14.'
                        : 'Made before 2017-11-30.'
                  },
                  [`Era ${era}`]
                ),
              requiresJs &&
                Elem(
                  'span',
                  {
                    className: 'badge js-badge',
                    title:
                      'The site may require JavaScript to show up properly. Try opening the site in a new tab.'
                  },
                  ['Req. JS']
                ),
              Elem(
                'a',
                {
                  className: 'badge visited-badge',
                  href: path,
                  tabIndex: -1
                },
                ['Visited']
              )
            ])
          ]),
          Elem('buttons', { className: 'buttons' }, [rejectBtn, acceptBtn])
        ])
        return card
      }

      function createLiked (path, title, description) {
        return Elem('a', { className: 'liked', href: path, target: '_blank' }, [
          Elem('p', { className: 'like-title' }, [title]),
          Elem('p', { className: 'like-description' }, [description])
        ])
      }

      const cards = document.getElementById('cards')
      const deck = document.getElementById('deck')
      const next = document.getElementById('next')
      const parser = new DOMParser()
      let animationEnd
      async function showCardForPath (path) {
        if (!path) {
          return
        }
        // Assumes that the `next` card is ready to be flipped. This is already
        // the case after accepting/rejecting.
        const doc = await fetch(path)
          .then(r => r.text())
          .then(html => parser.parseFromString(html, 'text/html'))
        const card = createCard(
          path,
          doc.querySelector('title')?.textContent ?? path,
          doc
            .querySelector('meta[name="description"][content]')
            ?.getAttribute('content'),
          // The sheep.js version used gives an approximate date
          doc.querySelector('script[src*="sheep3.js"]')
            ? 3 // Starting 2018-12-15
            : doc.querySelector('script[src*="sheep2.js"]')
            ? 2 // Starting 2017-11-30
            : doc.querySelector('script[src*="sheep.js"]')
            ? 1
            : null,
          // If there's a non sheep.js script tag and the page is empty, then it
          // probably requires JS to render
          doc.querySelector(
            'script:not([src*="sheep.js"]):not([src*="sheep2.js"]):not([src*="sheep3.js"])'
          ) &&
            [...doc.body.childNodes].every(node =>
              node.nodeType === Node.ELEMENT_NODE
                ? node.tagName === 'SCRIPT' ||
                  node.tagName === 'CANVAS' ||
                  node.textContent.trim()
                : node.nodeType === Node.TEXT_NODE
                ? node.nodeValue.trim()
                : true
            )
        )
        cards.append(card)
        if (paths.length > 0) {
          deck.classList.replace('hidden', 'come-in')
        }
        next.classList.replace('unselected', 'flip-out')
        card.classList.add('flip-in')
        animationEnd = new Promise(resolve => {
          card.addEventListener(
            'animationend',
            () => {
              // Animation of card flip is done.
              if (paths.length > 0) {
                deck.classList.replace('come-in', 'hidden')
                next.classList.replace('flip-out', 'unselected')
              } else {
                next.classList.replace('flip-out', 'hidden')
              }
              card.classList.remove('flip-in')
              resolve()
            },
            { once: true }
          )
        })
      }

      if (results.likes.length > 0) {
        likesContainer.classList.remove('hide-likes')
        for (const { path, title, description } of results.likes) {
          spacer.after(createLiked(path, title, description))
        }
      }
    </script>
  </body>
</html>
